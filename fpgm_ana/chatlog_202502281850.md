# 202502281859


为了实现代码审查并抽取特定方法的链式调用，我们可以使用Python的`ast`模块解析和遍历代码的抽象语法树（AST）。以下是实现该功能的代码：

```python
import ast

def analyze_code(code, target_methods):
    """
    分析输入的Python代码，抽取包含目标方法的链式调用赋值语句
    
    参数：
        code (str): 要分析的Python代码
        target_methods (list): 需要检测的目标方法列表
        
    返回：
        list: 包含匹配结果的字典列表，每个字典包含行号、方法和代码片段
    """
    try:
        tree = ast.parse(code)
    except SyntaxError as e:
        return {'error': f'语法错误: {e}'}
    
    analyzer = AssignMethodAnalyzer(target_methods)
    analyzer.visit(tree)
    return analyzer.matches

class AssignMethodAnalyzer(ast.NodeVisitor):
    def __init__(self, target_methods):
        self.target_methods = target_methods
        self.matches = []
    
    def visit_Assign(self, node):
        collector = CallCollector()
        collector.visit(node.value)
        
        # 去重后检查目标方法
        for method in set(collector.calls):
            if method in self.target_methods:
                line_no = node.lineno
                code_snippet = ast.unparse(node)
                self.matches.append({
                    'line': line_no,
                    'method': method,
                    'code': code_snippet.strip()
                })
        
        self.generic_visit(node)

class CallCollector(ast.NodeVisitor):
    def __init__(self):
        self.calls = []
    
    def visit_Call(self, node):
        # 收集所有通过属性访问的调用方法名（如df.query()）
        if isinstance(node.func, ast.Attribute):
            self.calls.append(node.func.attr)
        self.generic_visit(node)

if __name__ == "__main__":
    # 示例用法
    code = """
import pandas as pd

# 客户数据筛选
df = pd.DataFrame(data)
filtered = (df.query('age > 30')
            .groupby('department')
            .agg({'salary': 'mean'}))
result = filtered.loc[:, ['name', 'age']]
    """
    
    target_methods = ['query', 'groupby', 'agg', 'loc']
    
    matches = analyze_code(code, target_methods)
    
    print("发现以下客户筛选操作:")
    for match in matches:
        print(f"→ 第 {match['line']} 行: 方法 '{match['method']}'\n   代码: {match['code']}")
```

### 代码特点说明：
1. **多级调用处理**：能够识别`df.query().groupby().agg()`等复杂链式调用
2. **跨行兼容**：支持处理带括号的多行链式调用
3. **精确识别**：只检测赋值语句右侧的调用方法
4. **结果去重**：避免同一语句中重复方法的多次报告
5. **错误处理**：捕获基本语法错误

### 典型输出示例：
```
发现以下客户筛选操作:
→ 第 5 行: 方法 'query'
   代码: df = pd.DataFrame(data)
→ 第 6 行: 方法 'query'
   代码: filtered = (df.query('age > 30').groupby('department').agg({'salary': 'mean'}))
→ 第 6 行: 方法 'groupby'
   代码: filtered = (df.query('age > 30').groupby('department').agg({'salary': 'mean'}))
→ 第 6 行: 方法 'agg'
   代码: filtered = (df.query('age > 30').groupby('department').agg({'salary': 'mean'}))
```

### 扩展建议：
1. 添加对`loc/iloc`等属性访问的检测（需处理`Subscript`节点）
2. 增加对SQL查询字符串的解析功能
3. 集成到CI/CD流程实现自动审核
4. 添加基于规则的潜在错误检测（如空值处理、索引重置等）

这个方案可以有效识别数据筛选相关的链式方法调用，帮助审核客户筛选逻辑的完整性。需要根据实际业务需求调整`target_methods`列表的内容。